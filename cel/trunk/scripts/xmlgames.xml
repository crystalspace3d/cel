<world>
    <textures>
        <texture name="picture1">
	    <file>/this/data/to_the_tavern.jpg</file>
	    <keepimage />
        </texture>
    </textures>
    <materials>
	<material name="picture1"> <texture>picture1</texture> </material>
    </materials>
    <settings>
        <clearscreen>yes</clearscreen>
        <clearzbuf>yes</clearzbuf>
    </settings>
    <plugins>
        <plugin name="celentity">cel.addons.celentity</plugin>
        <plugin name="xmlscripts">cel.addons.xmlscripts</plugin>
    </plugins>

    <addon plugin="xmlscripts">
        <pcfactory>cel.pcfactory.mesh</pcfactory>
        <pcfactory>cel.pcfactory.solid</pcfactory>
        <pcfactory>cel.pcfactory.gravity</pcfactory>
        <pcfactory>cel.pcfactory.movable</pcfactory>
        <pcfactory>cel.pcfactory.billboard</pcfactory>
        <pcfactory>cel.pcfactory.properties</pcfactory>
        <pcfactory>cel.pcfactory.timer</pcfactory>

	<script name="menu">
	    <event name="init">
	        <print value="'Start initializing menu...'" />
		<createentity name="but" behaviour="menu_button" />
	    </event>
	    <event name="destroy">
	        <print value="'Start destroying menu...'" />
	        <destroyentity name="but" />
	    </event>
	</script>
	<script name="menu_button">
	    <event name="init">
	        <createpropclass name="pcbillboard" />
		<default propclass="pc(pcbillboard)" />
	        <property id="propid(name)" value="picture1" />
	        <property id="propid(materialname)" value="picture1" />
	        <property id="propid(movable)" value="false" />
	        <property id="propid(clickable)" value="true" />
	        <property id="propid(restack)" value="true" />
	        <property id="propid(width)" value="75000" />
	        <property id="propid(height)" value="75000" />
	        <property id="propid(x)" value="10000" />
	        <property id="propid(y)" value="10000" />
	    </event>
	    <event name="pcbillboard_select">
	        <call entity="menu" event="destroy" />
		<createentity name="puzzle_main" behaviour="puzzle_main" />
	    </event>
	</script>

	<script name="puzzle_main">
	    <event name="initcel">
	        <var name="ent" value="'p'+?x+'_'+?y" />
		<print value="'Creating '+?ent" />
		<createentity name="?ent" behaviour="moving_object" />
		<default propclass="pc(?ent,pcbillboard)" />
	        <property id="propid(x)" value="1000+75000*?x" />
	        <property id="propid(y)" value="1000+75000*?y" />
		<var name="tl" value="[?x,?y]*.25" />
	        <property id="propid(uv_topleft)" value="?tl" />
	        <property id="propid(uv_botright)"
			value="?tl + [.25,.25]" />
		<!-- Set the 2d grid to contain the current entity -->
	        <var name="'grid'+?x+'_'+?y" value="?ent" />
	    </event>
	    <event name="initrow">
		<for var="x" start="0" end="3" exec="initcel" />
	    </event>
	    <event name="init">
	        <var name="uvtl" value="[0,0]" />
		<for var="y" start="0" end="3" exec="initrow" />

		<!-- Clear the item at 3,3 -->
		<property propclass="pc(p3_3,pcbillboard)"
			id="propid(visible)" value="false" />
		<property propclass="pc(p3_3,pcbillboard)"
			id="propid(clickable)" value="false" />
	        <var name="'grid'+3+'_'+3" value="''" />

	        <var name="emptyx" value="3" />
	        <var name="emptyy" value="3" />
		<var name="allowmove" value="false" />
		<var name="shuffle_count" value="100" />
		<call event="fast_shuffle" />
	    </event>
	    <event name="fast_shuffle">
	        <var name="dxdy" value="int(rand(4.0))" />
		<if eval="?dxdy&2">
		    <true>
		        <var name="dx" value="0" />
		        <var name="dy" value="if(?dxdy&1,1,-1)" />
		    </true>
		    <false>
		        <var name="dx" value="if(?dxdy&1,1,-1)" />
		        <var name="dy" value="0" />
		    </false>
		</if>
		<var name="bx" value="?emptyx+?dx" />
		<var name="by" value="?emptyy+?dy" />
		<if eval="?bx < 4 && ?bx >= 0 && ?by < 4 && ?by >= 0">
		    <true>
		        <var name="ent" value="?('grid'+?bx+'_'+?by)" />
		        <var entity="?ent" name="dx" value="-?dx" />
		        <var entity="?ent" name="dy" value="-?dy" />
			<call entity="?ent" event="move" />
		    </true>
		    <false>
		        <call event="fast_shuffle" />
		    </false>
		</if>
	    </event>
	</script>

        <script name="moving_object">
	    <event name="init">
	        <createpropclass name="pctimer" />
	        <createpropclass name="pcbillboard" />
		<default propclass="pc(pcbillboard)" />
	        <property id="propid(name)" value="picture1" />
	        <property id="propid(materialname)" value="picture1" />
	        <property id="propid(movable)" value="false" />
	        <property id="propid(clickable)" value="true" />
	        <property id="propid(restack)" value="true" />
	        <property id="propid(width)" value="75000" />
	        <property id="propid(height)" value="75000" />
		<var name="rightx" value="?puzzle_main.x" />
		<var name="righty" value="?puzzle_main.y" />
		<var name="curx" value="?rightx" />
		<var name="cury" value="?righty" />
	    </event>

	    <event name="pctimer_wakeupframe">
		<default propclass="pc(pcbillboard)" />
	        <property id="propid(x)"
			value="1000+intpol(?delta,?intx1,?intx2)*75000" />
	        <property id="propid(y)"
			value="1000+intpol(?delta,?inty1,?inty2)*75000" />
		<if eval="?delta>=1" true="stoptimer" />
		<var name="delta" value="?delta+0.01*param(parid(elapsedticks))" />
	    </event>
	    <event name="stoptimer">
		<action propclass="pc(pctimer)" id="propid(Clear)" />
		<default propclass="pc(pcbillboard)" />
	        <property id="propid(x)" value="1000+?curx*75000" />
	        <property id="propid(y)" value="1000+?cury*75000" />
		<if eval="?puzzle_main.shuffle_count>0">
		    <true>
		        <var entity="puzzle_main" name="shuffle_count"
				value="?puzzle_main.shuffle_count-1" />
		        <call entity="puzzle_main" event="fast_shuffle" />
		    </true>
		    <false>
		        <var entity="puzzle_main" name="allowmove"
				value="true" />
		    </false>
		</if>
	    </event>

	    <event name="move">
		<var entity="puzzle_main" name="allowmove" value="false" />
		<var entity="puzzle_main" name="emptyx" value="?curx" />
		<var entity="puzzle_main" name="emptyy" value="?cury" />
		<var name="intx1" value="float(?curx)" />
		<var name="inty1" value="float(?cury)" />
		<!-- Make current grid item empty -->
	        <var entity="puzzle_main" name="'grid'+?curx+'_'+?cury"
			value="''" />
		<var name="curx" value="?curx+?dx" />
		<var name="cury" value="?cury+?dy" />
		<!-- Fill new grid item with current entity -->
	        <var entity="puzzle_main" name="'grid'+?curx+'_'+?cury"
			value="entname()" />
		<var name="intx2" value="float(?curx)" />
		<var name="inty2" value="float(?cury)" />
		<var name="delta" value="0.0" />
		<action propclass="pc(pctimer)" id="propid(WakeUpFrame)" />
	    </event>
	    <event name="pcbillboard_select">
	        <if eval="?puzzle_main.allowmove">
		    <true>
		        <var name="dx" value="?puzzle_main.emptyx-?curx" />
		        <var name="dy" value="?puzzle_main.emptyy-?cury" />
		        <if eval="(abs(?dx)==1&&?dy==0)||(abs(?dy)==1&&?dx==0)"
			    true="move" />
		    </true>
		</if>
	    </event>
	</script>

    </addon>

    <addon plugin="celentity" entityname="menu">
        <behaviour name="menu" />
    </addon>

    <!--
    <addon plugin="celentity" entityname="puzzle_main">
        <behaviour name="puzzle_main" />
    </addon>
    -->
</world>

