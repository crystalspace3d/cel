SubDir TOP plugins behaviourlayer python ;

if $(PYTHON.AVAILABLE) = yes
{
  #--------
  # pycel.py marshalling
  #--------
  local pycelcpp = [ DoSourceGrist PYCEL_py.cpp ] ;
  MarshallPyFile $(pycelcpp) : pycel.py : [ ConcatDirs $(TOP) scripts ] ;

  #--------
  # Swig-generated files.
  #--------
  local blcelcpp = blcel.cpp ;
  local blcelpy = [ DoSourceGrist blcelc.py ] ;
  MakeLocate $(blcelpy) : $(LOCATE.TARGETS) ;

  if ! [ Property build : projgen ]
  {
    blcelcpp = [ DoSourceGrist $(blcelcpp) ] ;

    if $(CMD.SWIG)
    {
      Swig $(blcelcpp) $(blcelpy) :
        [ DoSourceGrist blcel.i ] :
        python :
	-c++ -shadow -modern $(CRYSTAL.CFLAGS) :
	[ ConcatDirs $(TOP) include ] :
	[ ConcatDirs $(TOP) include bindings ] :
	$(SEARCH_SOURCE) [ ConcatDirs $(TOP) scripts ] :
	blcel :
	[ on $(blcelpy) GetVar LOCATE ] ;
      Depends blpythonclean : blcelswigclean ;
    }
    else
    {
      SEARCH on $(blcelcpp) = $(SEARCH_SOURCE) ;
    }
  }
  Clean blpythonclean : $(blcelpy) ;

  rule InstallCelPythonPY
  {
    # Temporary override for InstallData.
    local SUBDIR = [ on $(<) GetVar LOCATE ] ;
    InstallData $(<) : $(>) ;
  }
  InstallCelPythonPY $(blcelpy) : bindings python ;


  #--------
  # Compiler flags for Swig-generated code.
  #--------
  CELPYTHON.CFLAGS =
    $(COMPILER.C++FLAGS.WARNING.NO_UNUSED)
    $(COMPILER.C++FLAGS.WARNING.NO_UNINITIALIZED)
    $(COMPILER.C++FLAGS.STRICTALIASING.DISABLE) ;

  #--------
  # cel_python common library
  #--------
  Description cel_python : "Python-specific cel support" ;
  Library cel_python : $(blcelcpp) : shared independent optional ;
  ExternalLibs cel_python : PYTHON CRYSTAL ;
  LinkWith cel_python : celtool ;
  CFlags cel_python : $(CELPYTHON.CFLAGS) ;
  MsvcDefine cel_python : _CRT_SECURE_NO_DEPRECATE _CRT_NONSTDC_NO_DEPRECATE ;

  #--------
  # blpython plugin.
  #--------
  local swigruntime = swigpyruntime.h ;
  if $(CMD.SWIG)
  {
    SwigExternalRuntime $(swigruntime) :
      python :
      -c++ -shadow -modern :
      $(SEARCH_SOURCE) [ ConcatDirs $(TOP) scripts python ] :
      blpython ;
    Depends blpythonclean : blpythonswigclean ;
  }
  else
  {
    SEARCH on $(swigruntime) = $(SEARCH_SOURCE) ;
  }

  save_HDRS = $(HDRS) ;
  HDRS = [ on $(swigruntime) GetVar LOCATE ] $(HDRS) ;
  Plugin blpython : blpython.cpp blpython.h pytocel.cpp PYCEL_py.cpp ;
  LinkWith blpython : cel_python ;
  ExternalLibs blpython : PYTHON CRYSTAL ; 
  CFlags blpython : $(CELPYTHON.CFLAGS) ;
  HDRS = $(save_HDRS) ;

  #--------
  # blcelmod -- Pure Python module
  #--------
  PythMod blcelmod : _blcelc : celmod.cpp : cel_python : CRYSTAL
                : "pure Python module" ;
  CFlags blcelmod : $(CELPYTHON.CFLAGS) ;
}
