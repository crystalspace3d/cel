SubDir TOP scripts cel-config ;

# Generate cel-config
rule CelConfigGen
{
  SEARCH on cel-config.template = $(SUBDIR) ;
  MakeLocate $(<) : $(LOCATE.TARGETS) ;
  Depends $(<) : cel-config.template Jamfile Jamconfig [ ConcatDirs $(SUBDIR) Jamfile ] ;
  Clean $(<)clean : $(<) ;
  Depends clean : $(<)clean ;
  
  local l d e s liblist libdep libdepstr libstrings libaddstrings libbasestrs libbase libswitchcase ;
  
  for l in $(INSTALLEDLIBS) $(INSTALLEDLIBS_OPTIONAL)
  {
    libbase = [ LibraryBaseName $(l) ] ;
    libaddstrings += "    $(l)) \
	addlib \"-l$(libbase)\" 	\
	;;			\
" ;
    libdep = ;
    for d in $($(l)_depends)
    {
      local depbase = [ LibraryBaseName $(d) ] ;
      libdep += -l$(depbase) ;
    }
    for e in $($(l).EXTERNALLIBS)
    {
      libdep += $($(e).LFLAGS) ;
    }
    libdepstr = "" ;
    for s in $(libdep)
    {
      libdepstr = "$(libdepstr) $(s)" ;
    }
    libstrings += "       -l$(libbase)) DEPS=\"$(libdepstr)\" ;;\
" ;
    libbasestrs += "lib$(l)=$(libbase)
" ;
  }

  # Hack to have cs-config fake indirection on ubuntu dash
  for l in $(INSTALLEDLIBS) $(INSTALLEDLIBS_OPTIONAL)
  {
    # split this up since it seems impossible to escape \$
    libbase = [ LibraryBaseName $(l) ] ;
    libswitchcase += "   \"$(l)\"):
      libbase=$(libbase) ;;
" ;
  }

  liblist on $(<) = [ Sort $(INSTALLEDLIBS) ] ;
  liblist_opt on $(<) = [ Sort $(INSTALLEDLIBS_OPTIONAL) ] ;
  libstrings on $(<) = $(libstrings) ;
  libaddstrings on $(<) = $(libaddstrings) ;
  libbasestrs on $(<) = $(libbasestrs) ;
  libswitchcase on $(<) = $(libswitchcase) ;
  ENV_VERSION on $(<) = $(PACKAGE_VERSION_LIST[1])_$(PACKAGE_VERSION_LIST[2]) ;

  CelConfigGen1 cel-config : cel-config.template ;
}

actions CelConfigGen1
{
  cat > $(<) << __END__
#!/bin/sh
# cel-config -- Autogenerated.

# From autoconf:
# The user is always right.
if test "\${PATH_SEPARATOR+set}" != set; then
  echo "#! /bin/sh" >conf\$\$.sh
  echo  "exit 0"   >>conf\$\$.sh
  chmod +x conf\$\$.sh
  if (PATH="/nonexistent;."; conf\$\$.sh) >/dev/null 2>&1; then
    PATH_SEPARATOR=';'
  else
    PATH_SEPARATOR=:
  fi
  rm -f conf\$\$.sh
fi

CEL="\${CEL-$(prefix)\$PATH_SEPARATOR.}"
CEL_$(ENV_VERSION)="\${CEL_$(ENV_VERSION)-\$CEL}"
my_IFS=\$IFS; IFS=\$PATH_SEPARATOR
for p in \$CEL_$(ENV_VERSION)
do
  prefix="\${p}"
  exec_prefix="\${prefix}"
  makeout="$(LOCATE.OBJECTS)"
  version="$(PACKAGE_VERSION)"
  longversion="$(PACKAGE_STRING)"
  includedir=""
  # try to determine if we're in a source or installed CEL version
  if test "x\$includedir" = "x"
  then
    if [ -r \${prefix}/include/$(PACKAGE_NAME)-$(PACKAGE_VERSION)/celversion.h ] ; then
      includedir="\${prefix}/include/$(PACKAGE_NAME)-$(PACKAGE_VERSION)"
    elif [ -r \${prefix}/include/celversion.h ] ; then
      includedir="\${prefix}/include"
    fi
  fi
done
IFS=\$my_IFS
if test "x\$includedir" = "x"
then
  includedir="$(appincdir)"
fi
cflags="-I\${includedir}"

syslibs=" $(LINKLIBS) "
common_cflags=" $(COMPILER.CFLAGS.MANDATORY) "
common_cxxflags=" $(COMPILER.CFLAGS.MANDATORY) $(COMPILER.C++FLAGS.MANDATORY) "
staticdeps="$(STATICPLUGINS.DEPENDENCIES)"

# dependencies of CEL
depends()
{
    case \$1 in
 $(libstrings)
    esac
}

checklibname()
{
    case \$1 in
 $(libaddstrings)
    esac
}

libs="\
 $(liblist)
"
libs_opt="\
 $(liblist_opt)
"

$(libbasestrs)

__END__

  cat >> $(<) << __END__

# Hack to do variable indirection for posix compliant systems that don't use bash (like ubuntu)
give_libbase()
{
  case \$1 in
 $(libswitchcase)
    *)
      # should never ever happen
      echo "Internal error, due to unspecified libbase."
      exit;;
    esac
}

__END__
  cat $(>) >> $(<)
}

ShellScript cel-config : CelConfigGen ;

# Deprecated...
SEARCH on cel.cex = $(SUBDIR) ;
Depends install_bin : [ DoInstall cel.cex : $(bindir) : $(INSTALL_PROGRAM) ] ;
